# ๐ DIAGRAMAS DE SECUENCIA

## Escenario 1: Procesamiento Exitoso de Pedido

```
โโโโโโโโโโ         โโโโโโโโโโโโโโโโ       โโโโโโโโโโโโ       โโโโโโโโโโโโโโโโโโโโ
โCliente โ         โOrder Service โ       โ RabbitMQ โ       โInventory Service โ
โโโโโฌโโโโโ         โโโโโโโโฌโโโโโโโโ       โโโโโโฌโโโโโโ       โโโโโโโโโโฌโโโโโโโโโโ
    โ                     โ                     โ                      โ
    โ POST /orders        โ                     โ                      โ
    โโโโโโโโโโโโโโโโโโโโโ>โ                     โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 1. Validate Request โ                      โ
    โ                     โโโโโโโโโโโโโโโ       โ                      โ
    โ                     โ             โ       โ                      โ
    โ                     โ<โโโโโโโโโโโโโ       โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 2. Save Order       โ                      โ
    โ                     โ    (PENDING)        โ                      โ
    โ                     โโโโโโโโโโโโโโโ       โ                      โ
    โ                     โ             โ       โ                      โ
    โ                     โ<โโโโโโโโโโโโโ       โ                      โ
    โ                     โ                     โ                      โ
    โ 201 Created         โ                     โ                      โ
    โ {orderId, PENDING}  โ                     โ                      โ
    โ<โโโโโโโโโโโโโโโโโโโโโ                     โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 3. Publish          โ                      โ
    โ                     โ    OrderCreated     โ                      โ
    โ                     โโโโโโโโโโโโโโโโโโโโโ>โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ                     โ 4. Route to Queue    โ
    โ                     โ                     โโโโโโโโโโโโโโโโ       โ
    โ                     โ                     โ              โ       โ
    โ                     โ                     โ<โโโโโโโโโโโโโโ       โ
    โ                     โ                     โ                      โ
    โ                     โ                     โ 5. Consume Event     โ
    โ                     โ                     โโโโโโโโโโโโโโโโโโโโโโ>โ
    โ                     โ                     โ                      โ
    โ                     โ                     โ      6. Check Stock  โ
    โ                     โ                     โ      โโโโโโโโโโโโโโโโโค
    โ                     โ                     โ      โ               โ
    โ                     โ                     โ      โ<โโโโโโโโโโโโโโโค
    โ                     โ                     โ                      โ
    โ                     โ                     โ      7. Reserve Stockโ
    โ                     โ                     โ      โโโโโโโโโโโโโโโโโค
    โ                     โ                     โ      โ UPDATE DB     โ
    โ                     โ                     โ      โ<โโโโโโโโโโโโโโโค
    โ                     โ                     โ                      โ
    โ                     โ                     โ 8. Publish           โ
    โ                     โ                     โ    StockReserved     โ
    โ                     โ                     โ<โโโโโโโโโโโโโโโโโโโโโโ
    โ                     โ                     โ                      โ
    โ                     โ                     โ 9. Route to Queue    โ
    โ                     โ                     โโโโโโโโโโโโโโโโ       โ
    โ                     โ                     โ              โ       โ
    โ                     โ                     โ<โโโโโโโโโโโโโโ       โ
    โ                     โ                     โ                      โ
    โ                     โ 10. Consume         โ                      โ
    โ                     โ     StockReserved   โ                      โ
    โ                     โ<โโโโโโโโโโโโโโโโโโโโโ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 11. Update Order    โ                      โ
    โ                     โ     (CONFIRMED)     โ                      โ
    โ                     โโโโโโโโโโโโโโโ       โ                      โ
    โ                     โ             โ       โ                      โ
    โ                     โ<โโโโโโโโโโโโโ       โ                      โ
    โ                     โ                     โ                      โ
    โ GET /orders/{id}    โ                     โ                      โ
    โโโโโโโโโโโโโโโโโโโโโ>โ                     โ                      โ
    โ                     โ                     โ                      โ
    โ 200 OK              โ                     โ                      โ
    โ {status: CONFIRMED} โ                     โ                      โ
    โ<โโโโโโโโโโโโโโโโโโโโโ                     โ                      โ
    โ                     โ                     โ                      โ
```

---

## Escenario 2: Rechazo por Stock Insuficiente

```
โโโโโโโโโโ         โโโโโโโโโโโโโโโโ       โโโโโโโโโโโโ       โโโโโโโโโโโโโโโโโโโโ
โCliente โ         โOrder Service โ       โ RabbitMQ โ       โInventory Service โ
โโโโโฌโโโโโ         โโโโโโโโฌโโโโโโโโ       โโโโโโฌโโโโโโ       โโโโโโโโโโฌโโโโโโโโโโ
    โ                     โ                     โ                      โ
    โ POST /orders        โ                     โ                      โ
    โ (qty: 100)          โ                     โ                      โ
    โโโโโโโโโโโโโโโโโโโโโ>โ                     โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 1. Save Order       โ                      โ
    โ                     โ    (PENDING)        โ                      โ
    โ                     โโโโโโโโโโโโโโโ       โ                      โ
    โ                     โ             โ       โ                      โ
    โ                     โ<โโโโโโโโโโโโโ       โ                      โ
    โ                     โ                     โ                      โ
    โ 201 Created         โ                     โ                      โ
    โ {orderId, PENDING}  โ                     โ                      โ
    โ<โโโโโโโโโโโโโโโโโโโโโ                     โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 2. Publish          โ                      โ
    โ                     โ    OrderCreated     โ                      โ
    โ                     โโโโโโโโโโโโโโโโโโโโโ>โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ                     โ 3. Consume Event     โ
    โ                     โ                     โโโโโโโโโโโโโโโโโโโโโโ>โ
    โ                     โ                     โ                      โ
    โ                     โ                     โ      4. Check Stock  โ
    โ                     โ                     โ      โโโโโโโโโโโโโโโโโค
    โ                     โ                     โ      โ Available: 25 โ
    โ                     โ                     โ      โ Requested: 100โ
    โ                     โ                     โ      โ โ INSUFFICIENTโ
    โ                     โ                     โ      โ<โโโโโโโโโโโโโโโค
    โ                     โ                     โ                      โ
    โ                     โ                     โ 5. Publish           โ
    โ                     โ                     โ    StockRejected     โ
    โ                     โ                     โ<โโโโโโโโโโโโโโโโโโโโโโ
    โ                     โ                     โ                      โ
    โ                     โ 6. Consume          โ                      โ
    โ                     โ    StockRejected    โ                      โ
    โ                     โ<โโโโโโโโโโโโโโโโโโโโโ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 7. Update Order     โ                      โ
    โ                     โ    (CANCELLED)      โ                      โ
    โ                     โ    + reason         โ                      โ
    โ                     โโโโโโโโโโโโโโโ       โ                      โ
    โ                     โ             โ       โ                      โ
    โ                     โ<โโโโโโโโโโโโโ       โ                      โ
    โ                     โ                     โ                      โ
    โ GET /orders/{id}    โ                     โ                      โ
    โโโโโโโโโโโโโโโโโโโโโ>โ                     โ                      โ
    โ                     โ                     โ                      โ
    โ 200 OK              โ                     โ                      โ
    โ {status: CANCELLED, โ                     โ                      โ
    โ  reason: "..."}     โ                     โ                      โ
    โ<โโโโโโโโโโโโโโโโโโโโโ                     โ                      โ
    โ                     โ                     โ                      โ
```

---

## Escenario 3: Pedido Multi-Producto con Rollback

```
โโโโโโโโโโ         โโโโโโโโโโโโโโโโ       โโโโโโโโโโโโ       โโโโโโโโโโโโโโโโโโโโ
โCliente โ         โOrder Service โ       โ RabbitMQ โ       โInventory Service โ
โโโโโฌโโโโโ         โโโโโโโโฌโโโโโโโโ       โโโโโโฌโโโโโโ       โโโโโโโโโโฌโโโโโโโโโโ
    โ                     โ                     โ                      โ
    โ POST /orders        โ                     โ                      โ
    โ Items: P-001 (2),   โ                     โ                      โ
    โ        P-004 (100)  โ                     โ                      โ
    โโโโโโโโโโโโโโโโโโโโโ>โ                     โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 1. Save Order       โ                      โ
    โ                     โ    (PENDING)        โ                      โ
    โ                     โโโโโโโโโโโโโโโ       โ                      โ
    โ                     โ             โ       โ                      โ
    โ                     โ<โโโโโโโโโโโโโ       โ                      โ
    โ                     โ                     โ                      โ
    โ 201 Created         โ                     โ                      โ
    โ<โโโโโโโโโโโโโโโโโโโโโ                     โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 2. Publish Event    โ                      โ
    โ                     โโโโโโโโโโโโโโโโโโโโโ>โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ                     โ 3. Consume           โ
    โ                     โ                     โโโโโโโโโโโโโโโโโโโโโโ>โ
    โ                     โ                     โ                      โ
    โ                     โ                     โ   4. Process P-001   โ
    โ                     โ                     โ   โโโโโโโโโโโโโโโโโโโโค
    โ                     โ                     โ   โ โ Stock OK (25) โ
    โ                     โ                     โ   โ Reserve 2 units  โ
    โ                     โ                     โ   โ<โโโโโโโโโโโโโโโโโโค
    โ                     โ                     โ                      โ
    โ                     โ                     โ   5. Process P-004   โ
    โ                     โ                     โ   โโโโโโโโโโโโโโโโโโโโค
    โ                     โ                     โ   โ โ Stock FAIL    โ
    โ                     โ                     โ   โ (need 100, have 15)
    โ                     โ                     โ   โ<โโโโโโโโโโโโโโโโโโค
    โ                     โ                     โ                      โ
    โ                     โ                     โ   6. ROLLBACK P-001  โ
    โ                     โ                     โ   โโโโโโโโโโโโโโโโโโโโค
    โ                     โ                     โ   โ Release 2 units  โ
    โ                     โ                     โ   โ Stock back to 25 โ
    โ                     โ                     โ   โ<โโโโโโโโโโโโโโโโโโค
    โ                     โ                     โ                      โ
    โ                     โ                     โ 7. Publish Rejected  โ
    โ                     โ                     โ<โโโโโโโโโโโโโโโโโโโโโโ
    โ                     โ                     โ                      โ
    โ                     โ 8. Consume Rejected โ                      โ
    โ                     โ<โโโโโโโโโโโโโโโโโโโโโ                      โ
    โ                     โ                     โ                      โ
    โ                     โ 9. Cancel Order     โ                      โ
    โ                     โโโโโโโโโโโโโโโ       โ                      โ
    โ                     โ             โ       โ                      โ
    โ                     โ<โโโโโโโโโโโโโ       โ                      โ
    โ                     โ                     โ                      โ
    โ GET /orders/{id}    โ                     โ                      โ
    โโโโโโโโโโโโโโโโโโโโโ>โ                     โ                      โ
    โ                     โ                     โ                      โ
    โ {status: CANCELLED} โ                     โ                      โ
    โ<โโโโโโโโโโโโโโโโโโโโโ                     โ                      โ
    โ                     โ                     โ                      โ
    โ                     โ                     โ                      โ
```

---

## Tiempos de Procesamiento Estimados

| Paso | Operaciรณn | Tiempo |
|------|-----------|--------|
| 1 | Cliente โ Order Service | < 100ms |
| 2 | Validaciรณn y guardado en DB | < 50ms |
| 3 | Publicaciรณn a RabbitMQ | < 10ms |
| 4 | RabbitMQ โ Inventory Service | < 50ms |
| 5 | Verificaciรณn y reserva de stock | < 100ms |
| 6 | Publicaciรณn de respuesta | < 10ms |
| 7 | RabbitMQ โ Order Service | < 50ms |
| 8 | Actualizaciรณn de estado | < 50ms |
| **TOTAL** | **Procesamiento completo** | **~300-500ms** |

---

## Estados de la Orden

```
  โโโโโโโโโโโโ
  โ  INICIO  โ
  โโโโโโฌโโโโโโ
       โ
       โ Cliente crea pedido
       โผ
  โโโโโโโโโโโโ
  โ PENDING  โ โโโโโ Estado inicial al crear
  โโโโโโฌโโโโโโ       (Guardado en DB)
       โ
       โ Publicaciรณn: OrderCreated
       โ
       โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
       โ                 โ                 โ
       โ Stock OK        โ                 โ Stock NO
       โ                 โ                 โ
       โผ                 โผ                 โผ
  โโโโโโโโโโโโ     โโโโโโโโโโโโ     โโโโโโโโโโโโ
  โCONFIRMED โ     โ  Error   โ     โCANCELLED โ
  โโโโโโโโโโโโ     โโโโโโโโโโโโ     โโโโโโฌโโโโโโ
       โ                 โ                โ
       โ                 โ                โ
       โ                 โ                โโโโบ + cancellationReason
       โ                 โ
       โ                 โโโโบ Rollback y CANCELLED
       โ
       โโโโบ Stock reservado
            (Pedido completado)
```

---

## Componentes del Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         DOCKER COMPOSE                          โ
โ                                                                 โ
โ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ   โ
โ  โ   RabbitMQ    โ  โ  PostgreSQL   โ  โ  Order Service   โ   โ
โ  โ               โ  โ               โ  โ                  โ   โ
โ  โ Port: 5672    โ  โ Port: 5432    โ  โ Port: 8080       โ   โ
โ  โ Mgmt: 15672   โ  โ               โ  โ                  โ   โ
โ  โ               โ  โ DB: inventory โ  โ DB: H2 (memory)  โ   โ
โ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ              Inventory Service (Node.js)                  โ โ
โ  โ                                                           โ โ
โ  โ              Port: 8081                                   โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                 โ
โ  Network: microservices-network                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Universidad de las Fuerzas Armadas (ESPE)**  
Diagramas de Secuencia - Sistema E-Commerce  
Aplicaciones Distribuidas - Enero 2026
